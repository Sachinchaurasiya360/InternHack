generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

// ============================================================
// ENUMS
// ============================================================

enum UserRole {
  STUDENT
  RECRUITER
  ADMIN
}

enum JobStatus {
  DRAFT
  PUBLISHED
  CLOSED
  ARCHIVED
}

enum ApplicationStatus {
  APPLIED
  IN_PROGRESS
  SHORTLISTED
  REJECTED
  HIRED
  WITHDRAWN
}

enum RoundStatus {
  PENDING
  IN_PROGRESS
  COMPLETED
  SKIPPED
}

enum FieldType {
  TEXT
  TEXTAREA
  DROPDOWN
  MULTI_SELECT
  FILE_UPLOAD
  BOOLEAN
  NUMERIC
  DATE
  EMAIL
  URL
}

enum CompanySize {
  STARTUP
  SMALL
  MEDIUM
  LARGE
  ENTERPRISE
}

enum ReviewStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ContributionStatus {
  PENDING
  APPROVED
  REJECTED
}

enum ContributionType {
  NEW_COMPANY
  EDIT_COMPANY
  ADD_CONTACT
  ADD_REVIEW
}

enum AdminTier {
  SUPER_ADMIN
  ADMIN
  MODERATOR
}

enum SubscriptionPlan {
  FREE
  MONTHLY
  YEARLY
}

enum SubscriptionStatus {
  ACTIVE
  EXPIRED
  CANCELLED
}

// ============================================================
// USER MODEL
// ============================================================

model user {
  id          Int      @id @default(autoincrement())
  name        String
  email       String   @unique
  password    String
  role        UserRole @default(STUDENT)
  isActive    Boolean  @default(true)
  contactNo   String?
  profilePic  String?
  resumes     String[] @default([])
  company     String?
  designation String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  // ── Subscription fields ──
  subscriptionPlan      SubscriptionPlan   @default(FREE)
  subscriptionStatus    SubscriptionStatus @default(EXPIRED)
  subscriptionStartDate DateTime?
  subscriptionEndDate   DateTime?

  // ── Student profile fields ──
  bio            String?
  college        String?
  graduationYear Int?
  skills         String[] @default([])
  linkedinUrl    String?
  githubUrl      String?
  portfolioUrl   String?
  location       String?

  postedJobs        job[]                  @relation("RecruiterJobs")
  applications      application[]          @relation("StudentApplications")
  atsScores         atsScore[]             @relation("StudentAtsScores")
  careerEnrollments studentCareer[]        @relation("StudentCareers")
  skillProgress     studentSkillProgress[] @relation("StudentSkillProgress")

  companyReviews        companyReview[]       @relation("UserReviews")
  addedContacts         companyContact[]      @relation("UserAddedContacts")
  contributions         companyContribution[] @relation("UserContributions")
  reviewedContributions companyContribution[] @relation("AdminReviewedContributions")
  createdCompanies      company[]             @relation("UserCreatedCompanies")

  adminProfile      adminProfile?      @relation("AdminProfile")
  adminActivityLogs adminActivityLog[] @relation("AdminActivityLogs")
  payments          payment[]          @relation("UserPayments")
}

// ============================================================
// ADMIN PROFILE MODEL
// ============================================================

model adminProfile {
  id        Int       @id @default(autoincrement())
  userId    Int       @unique
  user      user      @relation("AdminProfile", fields: [userId], references: [id], onDelete: Cascade)
  tier      AdminTier @default(ADMIN)
  isActive  Boolean   @default(true)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

// ============================================================
// ADMIN ACTIVITY LOG MODEL
// ============================================================

model adminActivityLog {
  id         Int      @id @default(autoincrement())
  adminId    Int
  admin      user     @relation("AdminActivityLogs", fields: [adminId], references: [id])
  action     String
  targetType String
  targetId   Int
  details    Json     @default("{}")
  ipAddress  String?
  createdAt  DateTime @default(now())

  @@index([adminId])
  @@index([targetType, targetId])
  @@index([createdAt])
}

// ============================================================
// JOB MODEL
// ============================================================

model job {
  id           Int       @id @default(autoincrement())
  title        String
  description  String
  location     String
  salary       String
  company      String
  status       JobStatus @default(DRAFT)
  customFields Json      @default("[]")
  deadline     DateTime?
  tags         String[]  @default([])
  recruiterId  Int
  recruiter    user      @relation("RecruiterJobs", fields: [recruiterId], references: [id])

  rounds       round[]
  applications application[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

// ============================================================
// ROUND MODEL
// ============================================================

model round {
  id                 Int     @id @default(autoincrement())
  jobId              Int
  job                job     @relation(fields: [jobId], references: [id], onDelete: Cascade)
  name               String
  description        String?
  orderIndex         Int
  instructions       String?
  customFields       Json    @default("[]")
  evaluationCriteria Json    @default("[]")

  roundSubmissions roundSubmission[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([jobId, orderIndex])
}

// ============================================================
// APPLICATION MODEL
// ============================================================

model application {
  id                 Int               @id @default(autoincrement())
  jobId              Int
  job                job               @relation(fields: [jobId], references: [id], onDelete: Cascade)
  studentId          Int
  student            user              @relation("StudentApplications", fields: [studentId], references: [id])
  status             ApplicationStatus @default(APPLIED)
  currentRoundId     Int?
  customFieldAnswers Json              @default("{}")
  resumeUrl          String?
  coverLetter        String?

  roundSubmissions roundSubmission[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([jobId, studentId])
}

// ============================================================
// ROUND SUBMISSION MODEL
// ============================================================

model roundSubmission {
  id               Int         @id @default(autoincrement())
  applicationId    Int
  application      application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  roundId          Int
  round            round       @relation(fields: [roundId], references: [id], onDelete: Cascade)
  status           RoundStatus @default(PENDING)
  fieldAnswers     Json        @default("{}")
  attachments      String[]    @default([])
  evaluationScores Json?
  recruiterNotes   String?
  submittedAt      DateTime?
  evaluatedAt      DateTime?
  createdAt        DateTime    @default(now())
  updatedAt        DateTime    @updatedAt

  @@unique([applicationId, roundId])
}

// ============================================================
// SCRAPED JOB ENUMS
// ============================================================

// ============================================================
// CAREER ROADMAP ENUMS
// ============================================================

enum CareerDifficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum ResourceType {
  ARTICLE
  VIDEO
  COURSE
  BOOK
  DOCUMENTATION
  TUTORIAL
}

enum SkillLevel {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum CareerCategory {
  ENGINEERING
  DESIGN
  DATA
  PRODUCT
  MARKETING
  DEVOPS
  SECURITY
  OTHER
}

enum EnrollmentStatus {
  ACTIVE
  PAUSED
  COMPLETED
}

// ============================================================
// SCRAPED JOB ENUMS
// ============================================================

enum ScrapedJobStatus {
  ACTIVE
  EXPIRED
  REMOVED
}

// ============================================================
// SCRAPED JOB MODEL
// ============================================================

model scrapedJob {
  id             Int              @id @default(autoincrement())
  title          String
  description    String
  company        String
  location       String
  salary         String?
  tags           String[]         @default([])
  applicationUrl String
  source         String
  sourceId       String
  sourceUrl      String?
  status         ScrapedJobStatus @default(ACTIVE)
  scrapedAt      DateTime         @default(now())
  lastSeenAt     DateTime         @default(now())
  metadata       Json             @default("{}")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([source, sourceId])
  @@index([status])
  @@index([source])
}

// ============================================================
// SCRAPE LOG MODEL
// ============================================================

// ============================================================
// ATS SCORE MODEL
// ============================================================

model atsScore {
  id              Int      @id @default(autoincrement())
  studentId       Int
  student         user     @relation("StudentAtsScores", fields: [studentId], references: [id])
  resumeUrl       String
  jobTitle        String?
  jobDescription  String?
  overallScore    Int
  categoryScores  Json
  suggestions     Json
  keywordAnalysis Json
  rawResponse     Json
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([studentId])
}

model scrapeLog {
  id          Int      @id @default(autoincrement())
  source      String
  status      String
  jobsFound   Int      @default(0)
  jobsCreated Int      @default(0)
  jobsUpdated Int      @default(0)
  error       String?
  duration    Int
  createdAt   DateTime @default(now())
}

// ============================================================
// CAREER ROADMAP MODELS
// ============================================================

model career {
  id          Int              @id @default(autoincrement())
  title       String           @unique
  slug        String           @unique
  description String
  category    CareerCategory
  difficulty  CareerDifficulty
  iconUrl     String?
  avgSalary   String?
  demandLevel String?
  phases      careerPhase[]
  enrollments studentCareer[]
  createdAt   DateTime         @default(now())
  updatedAt   DateTime         @updatedAt
}

model careerPhase {
  id            Int              @id @default(autoincrement())
  careerId      Int
  career        career           @relation(fields: [careerId], references: [id], onDelete: Cascade)
  title         String
  description   String?
  orderIndex    Int
  durationWeeks Int?
  skills        careerSkill[]
  resources     careerResource[]
  tools         careerTool[]
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  @@unique([careerId, orderIndex])
}

model careerSkill {
  id       Int                    @id @default(autoincrement())
  phaseId  Int
  phase    careerPhase            @relation(fields: [phaseId], references: [id], onDelete: Cascade)
  name     String
  level    SkillLevel
  progress studentSkillProgress[]
}

model careerResource {
  id      Int          @id @default(autoincrement())
  phaseId Int
  phase   careerPhase  @relation(fields: [phaseId], references: [id], onDelete: Cascade)
  title   String
  url     String
  type    ResourceType
  free    Boolean      @default(true)
}

model careerTool {
  id       Int         @id @default(autoincrement())
  phaseId  Int
  phase    careerPhase @relation(fields: [phaseId], references: [id], onDelete: Cascade)
  name     String
  url      String?
  category String?
}

model studentCareer {
  id        Int              @id @default(autoincrement())
  studentId Int
  student   user             @relation("StudentCareers", fields: [studentId], references: [id])
  careerId  Int
  career    career           @relation(fields: [careerId], references: [id])
  status    EnrollmentStatus @default(ACTIVE)
  createdAt DateTime         @default(now())
  updatedAt DateTime         @updatedAt

  @@unique([studentId, careerId])
}

model studentSkillProgress {
  id        Int         @id @default(autoincrement())
  studentId Int
  student   user        @relation("StudentSkillProgress", fields: [studentId], references: [id])
  skillId   Int
  skill     careerSkill @relation(fields: [skillId], references: [id], onDelete: Cascade)
  completed Boolean     @default(false)
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt

  @@unique([studentId, skillId])
}

// ============================================================
// COMPANY EXPLORER MODELS
// ============================================================

model company {
  id              Int         @id @default(autoincrement())
  name            String
  slug            String      @unique
  logo            String?
  description     String
  mission         String?
  industry        String
  size            CompanySize
  city            String
  state           String?
  address         String?
  officeLocations Json        @default("[]")
  website         String?
  socialLinks     Json        @default("{}")
  technologies    String[]    @default([])
  hiringStatus    Boolean     @default(false)
  foundedYear     Int?
  photos          String[]    @default([])
  avgRating       Float       @default(0)
  reviewCount     Int         @default(0)
  isApproved      Boolean     @default(false)
  createdById     Int
  createdBy       user        @relation("UserCreatedCompanies", fields: [createdById], references: [id])

  reviews  companyReview[]
  contacts companyContact[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([city])
  @@index([industry])
  @@index([isApproved])
}

model companyReview {
  id                  Int          @id @default(autoincrement())
  companyId           Int
  company             company      @relation(fields: [companyId], references: [id], onDelete: Cascade)
  userId              Int
  user                user         @relation("UserReviews", fields: [userId], references: [id])
  rating              Int
  title               String
  content             String
  pros                String?
  cons                String?
  interviewExperience String?
  workCulture         String?
  salaryInsights      String?
  status              ReviewStatus @default(PENDING)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
  @@index([status])
}

model companyContact {
  id          Int     @id @default(autoincrement())
  companyId   Int
  company     company @relation(fields: [companyId], references: [id], onDelete: Cascade)
  name        String
  designation String
  email       String?
  phone       String?
  linkedinUrl String?
  isPublic    Boolean @default(true)
  addedById   Int
  addedBy     user    @relation("UserAddedContacts", fields: [addedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([companyId])
}

model companyContribution {
  id           Int                @id @default(autoincrement())
  userId       Int
  user         user               @relation("UserContributions", fields: [userId], references: [id])
  type         ContributionType
  companyId    Int?
  data         Json
  status       ContributionStatus @default(PENDING)
  adminNotes   String?
  reviewedById Int?
  reviewedBy   user?              @relation("AdminReviewedContributions", fields: [reviewedById], references: [id])

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([status])
  @@index([userId])
}

model newsletterSubscriber {
  id        Int      @id @default(autoincrement())
  email     String   @unique
  createdAt DateTime @default(now())
}

// ============================================================
// PAYMENT ENUMS
// ============================================================

enum PaymentStatus {
  PENDING
  SUCCESS
  FAILED
}

// ============================================================
// PAYMENT MODEL
// ============================================================

model payment {
  id                Int              @id @default(autoincrement())
  userId            Int
  user              user             @relation("UserPayments", fields: [userId], references: [id])
  razorpayOrderId   String           @unique
  razorpayPaymentId String?
  razorpaySignature String?
  amount            Int // amount in paise
  currency          String           @default("INR")
  plan              SubscriptionPlan
  billing           String // "monthly" or "yearly"
  status            PaymentStatus    @default(PENDING)
  createdAt         DateTime         @default(now())
  updatedAt         DateTime         @updatedAt

  @@index([userId])
  @@index([razorpayOrderId])
}

// ============================================================
// OPEN SOURCE REPO ENUMS
// ============================================================

enum RepoDifficulty {
  BEGINNER
  INTERMEDIATE
  ADVANCED
}

enum RepoDomain {
  AI
  WEB
  DEVOPS
  MOBILE
  BLOCKCHAIN
  DATA
  SECURITY
  CLOUD
  GAMING
  OTHER
}

// ============================================================
// OPEN SOURCE REPO MODEL
// ============================================================

model opensourceRepo {
  id          Int            @id @default(autoincrement())
  name        String
  owner       String
  description String
  language    String
  techStack   String[]       @default([])
  difficulty  RepoDifficulty @default(BEGINNER)
  domain      RepoDomain     @default(WEB)
  issueTypes  String[]       @default([])
  stars       Int            @default(0)
  forks       Int            @default(0)
  openIssues  Int            @default(0)
  url         String
  logo        String?
  tags        String[]       @default([])
  highlights  String[]       @default([])
  trending    Boolean        @default(false)
  lastUpdated DateTime       @default(now())
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@index([domain])
  @@index([difficulty])
  @@index([language])
}
